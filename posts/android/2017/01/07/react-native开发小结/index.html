<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>android react-native 开发小结（基于react-native 0.39） | Chaunce's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">android react-native 开发小结（基于react-native 0.39）</h1><a id="logo" href="/.">Chaunce's Blog</a><p class="description">不积跬步，无以至千里；不积小流，无以成江海</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">android react-native 开发小结（基于react-native 0.39）</h1><div class="post-meta">Jan 7, 2017<span> | </span><span class="category"><a href="/categories/android/">安卓</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-开发环境搭建"><span class="toc-number">1.</span> <span class="toc-text">1. 开发环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简要说明，省略android环境搭建过程："><span class="toc-number">1.1.</span> <span class="toc-text">简要说明，省略android环境搭建过程：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mac："><span class="toc-number">1.1.1.</span> <span class="toc-text">mac：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#windows："><span class="toc-number">1.1.2.</span> <span class="toc-text">windows：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选安装："><span class="toc-number">1.1.3.</span> <span class="toc-text">可选安装：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成react-native应用："><span class="toc-number">1.1.4.</span> <span class="toc-text">生成react-native应用：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-已有的原生应用，如何结合react-native"><span class="toc-number">2.</span> <span class="toc-text">2. 已有的原生应用，如何结合react-native</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#项目结构调整："><span class="toc-number">2.1.</span> <span class="toc-text">项目结构调整：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令解释："><span class="toc-number">2.2.</span> <span class="toc-text">命令解释：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#建议操作方式："><span class="toc-number">2.3.</span> <span class="toc-text">建议操作方式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Application示例："><span class="toc-number">2.4.</span> <span class="toc-text">Application示例：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BaseReactActivity示例："><span class="toc-number">2.5.</span> <span class="toc-text">BaseReactActivity示例：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReactViewContainActivity示例："><span class="toc-number">2.6.</span> <span class="toc-text">ReactViewContainActivity示例：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BaseReactFragment示例"><span class="toc-number">2.7.</span> <span class="toc-text">BaseReactFragment示例:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fragment用法："><span class="toc-number">2.8.</span> <span class="toc-text">Fragment用法：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-react-native、原生模块相互调用"><span class="toc-number">3.</span> <span class="toc-text">3. react-native、原生模块相互调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#根据具体情况分为以下两类模块："><span class="toc-number">3.1.</span> <span class="toc-text">根据具体情况分为以下两类模块：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js和原生数据类型转换工具类："><span class="toc-number">3.2.</span> <span class="toc-text">js和原生数据类型转换工具类：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-如何发布react-native开发的相关js代码"><span class="toc-number">4.</span> <span class="toc-text">4. 如何发布react-native开发的相关js代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-jenkins自动打包的坑"><span class="toc-number">5.</span> <span class="toc-text">5. jenkins自动打包的坑</span></a></li></ol></div></div><div class="post-content"><h2 id="1-开发环境搭建"><a href="#1-开发环境搭建" class="headerlink" title="1. 开发环境搭建"></a>1. 开发环境搭建</h2><p>英文文档：<a href="https://facebook.github.io/react-native/docs/getting-started.html" target="_blank" rel="external">https://facebook.github.io/react-native/docs/getting-started.html</a></p>
<p>中文文档：<a href="http://reactnative.cn/docs/0.39/getting-started.html" target="_blank" rel="external">http://reactnative.cn/docs/0.39/getting-started.html</a></p>
<h3 id="简要说明，省略android环境搭建过程："><a href="#简要说明，省略android环境搭建过程：" class="headerlink" title="简要说明，省略android环境搭建过程："></a>简要说明，省略android环境搭建过程：</h3><h4 id="mac："><a href="#mac：" class="headerlink" title="mac："></a>mac：</h4><p>Homebrew（包管理）——&gt;node（js开发，包含npm命令）,watchman（文件变动检测），flow（<a href="http://www.flowtype.org" target="_blank" rel="external">Flow</a>是一个静态的JS类型检查工具）——&gt;react-native-cli（react-native环境，使用npm命令安装）</p>
<h4 id="windows："><a href="#windows：" class="headerlink" title="windows："></a>windows：</h4><p>Chocolatey（包管理）——&gt;Python 2，node（js开发，包含npm命令）——&gt;react-native-cli（react-native，使用npm命令安装）</p>
<h4 id="可选安装："><a href="#可选安装：" class="headerlink" title="可选安装："></a>可选安装：</h4><p>淘宝镜像，可加速node module下载，否则国内需要翻墙</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm config set registry https://registry.npm.taobao.org --global</div><div class="line">npm config set disturl https://npm.taobao.org/dist --global</div></pre></td></tr></table></figure>
<h4 id="生成react-native应用："><a href="#生成react-native应用：" class="headerlink" title="生成react-native应用："></a>生成react-native应用：</h4><blockquote>
<p>react-native init AwesomeProject（初始化项目，项目名称AwesomeProject）<br>cd AwesomeProject（进入项目目录）<br>react-native start（开启node服务）<br>react-native run-android（打包生成apk并安装）</p>
</blockquote>
<h2 id="2-已有的原生应用，如何结合react-native"><a href="#2-已有的原生应用，如何结合react-native" class="headerlink" title="2. 已有的原生应用，如何结合react-native"></a>2. 已有的原生应用，如何结合react-native</h2><p>英文文档：<a href="https://facebook.github.io/react-native/docs/integration-with-existing-apps.html" target="_blank" rel="external">https://facebook.github.io/react-native/docs/integration-with-existing-apps.html</a></p>
<p>中文文档：<a href="http://reactnative.cn/docs/0.39/integration-with-existing-apps.html#content" target="_blank" rel="external">http://reactnative.cn/docs/0.39/integration-with-existing-apps.html#content</a></p>
<h3 id="项目结构调整："><a href="#项目结构调整：" class="headerlink" title="项目结构调整："></a>项目结构调整：</h3><p>参照AwesomeProject目录结构，原有的代码需放在<strong>android</strong>目录下：</p>
<table>
<thead>
<tr>
<th><strong>AwesomeProject</strong>（名称可以根据自己需要）</th>
<th><strong>android</strong>（名称不要修改）</th>
<th><strong>app</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td><strong>index.android.js</strong></td>
<td></td>
</tr>
<tr>
<td></td>
<td>ios</td>
<td></td>
</tr>
<tr>
<td></td>
<td>index.ios.js</td>
<td></td>
</tr>
<tr>
<td></td>
<td>node_modules</td>
<td></td>
</tr>
<tr>
<td></td>
<td><strong>package.json</strong></td>
</tr>
</tbody>
</table>
<p><strong>package.json</strong>用来记录项目中使用到的node_modules的依赖，在AwesomeProject（项目根目录）目录下执行<strong><em>npm install</em></strong>可以下载生成node_modules目录。也就是说node_modules是通过执行命令来生成的，不是项目本身的代码。<br><strong>index.android.js</strong>用来记录react-native模块的加载入口，可以注册多个，原生程序加载模块时，对应模块相应的名称即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">AppRegistry.registerComponent(<span class="string">'HomePage'</span>, () =&gt; AppointContainer);<span class="comment">//首页</span></div><div class="line">AppRegistry.registerComponent(<span class="string">'NewsList'</span>, () =&gt; Root); <span class="comment">//资讯主页面</span></div><div class="line">AppRegistry.registerComponent(<span class="string">'subInfo'</span>, () =&gt; subInfoRoot);<span class="comment">//资讯的子页面</span></div></pre></td></tr></table></figure>
<p>其余步骤可参照文档来。</p>
<h3 id="命令解释："><a href="#命令解释：" class="headerlink" title="命令解释："></a>命令解释：</h3><blockquote>
<p>$ npm init（生成package.json文件，填写相关信息）<br>$ npm install –save react react-native（下载并在项目中引用react-native模块，–save表示记录写入package.json）<br>$ curl -o .flowconfig <a href="https://raw.githubusercontent.com/facebook/react-native/master/.flowconfig" target="_blank" rel="external">https://raw.githubusercontent.com/facebook/react-native/master/.flowconfig</a> （添加flow配置，<a href="http://www.flowtype.org" target="_blank" rel="external">Flow</a>是一个静态的JS类型检查工具）</p>
</blockquote>
<h3 id="建议操作方式："><a href="#建议操作方式：" class="headerlink" title="建议操作方式："></a>建议操作方式：</h3><p>先使用react-native init AwesomeProject初始化一个项目，删除其中的android目录下源码，拷贝原有原生项目代码自android目录下，修改AwesomeProject名称（可选），由于已经有了初始化的<strong>package.json</strong>，无需再进行npm init操作，直接根目录下执行npm install。然后参照文档配置原生项目，原生项目build.gradle加入引用</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">     ...</div><div class="line">     compile <span class="string">"com.facebook.react:react-native:+"</span> <span class="comment">// From node_modules.</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>后续等操作参照链接文档。</p>
<h3 id="Application示例："><a href="#Application示例：" class="headerlink" title="Application示例："></a>Application示例：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">ReactApplication</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReactNativeHost mReactNativeHost = <span class="keyword">new</span> ReactNativeHost(<span class="keyword">this</span>) &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getUseDeveloperSupport</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> BuildConfig.DEBUG;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2. Override the getJSBundleFile method in order to let</span></div><div class="line">    <span class="comment">// the CodePush runtime determine where to get the JS</span></div><div class="line">    <span class="comment">// bundle location from on each app start</span></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> String <span class="title">getJSBundleFile</span><span class="params">()</span> </span>&#123;</div><div class="line">      Log.d(<span class="string">"code-push"</span>, CodePush.getJSBundleFile());</div><div class="line">      <span class="keyword">return</span> CodePush.getJSBundleFile();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> List&lt;ReactPackage&gt; <span class="title">getPackages</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// 3. Instantiate an instance of the CodePush runtime and add it to the list of</span></div><div class="line">      <span class="comment">// existing packages, specifying the right deployment key. If you don't already</span></div><div class="line">      <span class="comment">// have it, you can run "code-push deployment ls &lt;appName&gt; -k" to retrieve your key.</span></div><div class="line"></div><div class="line">      Log.d(<span class="string">"code-push"</span>, BuildConfig.CODEPUSH_KEY);</div><div class="line"></div><div class="line">      CodePush codePush = <span class="keyword">new</span> CodePush(BuildConfig.CODEPUSH_KEY, MyApplication.<span class="keyword">this</span>,</div><div class="line">          BuildConfig.DEBUG);</div><div class="line">      String appversion = codePush.getAppVersion();</div><div class="line">      String serverurl = codePush.getServerUrl();</div><div class="line"></div><div class="line">      Log.d(<span class="string">"code-push"</span>, <span class="string">"appversion-&gt;"</span> + appversion);</div><div class="line">      Log.d(<span class="string">"code-push"</span>, <span class="string">"serverurl-&gt;"</span> + serverurl);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> MainReactPackage(), <span class="keyword">new</span> ZMCNativeBridgeReactPackage(), codePush);</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> ReactNativeHost <span class="title">getReactNativeHost</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mReactNativeHost;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="BaseReactActivity示例："><a href="#BaseReactActivity示例：" class="headerlink" title="BaseReactActivity示例："></a>BaseReactActivity示例：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseReactActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span></div><div class="line">    <span class="keyword">implements</span> <span class="title">DefaultHardwareBackBtnHandler</span> &#123;</div><div class="line">  <span class="keyword">private</span> ReactRootView mReactRootView;</div><div class="line">  <span class="keyword">private</span> ReactInstanceManager mReactInstanceManager;</div><div class="line"></div><div class="line">  <span class="comment">// This method returns the name of our top-level component to show</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getMainComponentName</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Bundle <span class="title">getMainComponentParams</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">parseActivityParams</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">    <span class="comment">//用来解析bundle等参数</span></div><div class="line">    parseActivityParams();</div><div class="line"></div><div class="line">    mReactRootView = <span class="keyword">new</span> ReactRootView(<span class="keyword">this</span>);</div><div class="line">    mReactInstanceManager = ((MyApplication) getApplication()).</div><div class="line">        getReactNativeHost().getReactInstanceManager();</div><div class="line"></div><div class="line">    mReactRootView.startReactApplication(mReactInstanceManager, getMainComponentName(),</div><div class="line">        getMainComponentParams());</div><div class="line"></div><div class="line">    setContentView(mReactRootView);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invokeDefaultOnBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onBackPressed();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onPause();</div><div class="line">    <span class="keyword">if</span> (mReactInstanceManager != <span class="keyword">null</span>) &#123;</div><div class="line">      mReactInstanceManager.onHostPause(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onResume();</div><div class="line">    <span class="keyword">if</span> (mReactInstanceManager != <span class="keyword">null</span>) &#123;</div><div class="line">      mReactInstanceManager.onHostResume(<span class="keyword">this</span>, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mReactRootView != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//这里需要unmount，否则会内存泄露</span></div><div class="line">      mReactRootView.unmountReactApplication();</div><div class="line">      mReactRootView = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mReactInstanceManager != <span class="keyword">null</span>) &#123;</div><div class="line">      mReactInstanceManager.onHostDestroy(<span class="keyword">this</span>);</div><div class="line">      mReactInstanceManager = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mReactInstanceManager != <span class="keyword">null</span>) &#123;</div><div class="line">      mReactInstanceManager.onActivityResult(<span class="keyword">this</span>, requestCode, resultCode, data);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mReactInstanceManager != <span class="keyword">null</span>) &#123;</div><div class="line">      mReactInstanceManager.onBackPressed();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">super</span>.onBackPressed();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReactViewContainActivity示例："><a href="#ReactViewContainActivity示例：" class="headerlink" title="ReactViewContainActivity示例："></a>ReactViewContainActivity示例：</h3><p>该Activity可以包含任意React native的Component。</p>
<p>“target”中传打开React native的Component名称，String类型；“params”中传打开React native的Component所需要的参数，Bundle类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactViewContainActivity</span> <span class="keyword">extends</span> <span class="title">BaseReactActivity</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> String targetComponentName;</div><div class="line">  <span class="keyword">private</span> Bundle targetParams;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">getMainComponentName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> targetComponentName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Bundle <span class="title">getMainComponentParams</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> targetParams;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseActivityParams</span><span class="params">()</span> </span>&#123;</div><div class="line">    Bundle bundle = getIntent().getExtras();</div><div class="line">    targetComponentName = bundle.getString(<span class="string">"target"</span>);</div><div class="line">    targetParams = bundle.getBundle(<span class="string">"params"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="BaseReactFragment示例"><a href="#BaseReactFragment示例" class="headerlink" title="BaseReactFragment示例:"></a>BaseReactFragment示例:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseReactFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> ReactRootView mReactRootView;</div><div class="line">  <span class="keyword">private</span> ReactInstanceManager mReactInstanceManager;</div><div class="line"></div><div class="line">  <span class="comment">// This method returns the name of our top-level component to show</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getMainComponentName</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Bundle <span class="title">getMainComponentParams</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onAttach(context);</div><div class="line">    mReactRootView = <span class="keyword">new</span> ReactRootView(context);</div><div class="line">    mReactInstanceManager = ((MyApplication) getActivity().getApplication()).</div><div class="line">        getReactNativeHost().getReactInstanceManager();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Nullable</span> <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, @Nullable ViewGroup container,</span></span></div><div class="line">      @Nullable Bundle savedInstanceState) &#123;</div><div class="line">    <span class="keyword">return</span> mReactRootView;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">    mReactRootView.startReactApplication(mReactInstanceManager, getMainComponentName(),</div><div class="line">        getMainComponentParams());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mReactRootView != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//这里需要unmount，否则会内存泄露</span></div><div class="line">      mReactRootView.unmountReactApplication();</div><div class="line">      mReactRootView = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mReactInstanceManager != <span class="keyword">null</span>) &#123;</div><div class="line">      mReactInstanceManager = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> ReactRootView <span class="title">getmReactRootView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mReactRootView;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Fragment用法："><a href="#Fragment用法：" class="headerlink" title="Fragment用法："></a>Fragment用法：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsReactFragment</span> <span class="keyword">extends</span> <span class="title">BaseReactFragment</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> String <span class="title">getMainComponentName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"NewsList"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Bundle <span class="title">getMainComponentParams</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-react-native、原生模块相互调用"><a href="#3-react-native、原生模块相互调用" class="headerlink" title="3. react-native、原生模块相互调用"></a>3. react-native、原生模块相互调用</h2><h3 id="根据具体情况分为以下两类模块："><a href="#根据具体情况分为以下两类模块：" class="headerlink" title="根据具体情况分为以下两类模块："></a>根据具体情况分为以下两类模块：</h3><ol>
<li><p>react-native与原生互相调用，无view交互模块，继承<strong>ReactContextBaseJavaModule</strong>，添加交互方法。</p>
<p>可参照：<a href="http://www.jianshu.com/p/07b928feee3b" target="_blank" rel="external">http://www.jianshu.com/p/07b928feee3b</a></p>
</li>
<li><p>原生提供view模块供react-native于js代码上调用（包含view属性设置），则继承<strong>SimpleViewManager</strong>，实现相应逻辑。</p>
<p>可参照：<a href="http://www.jianshu.com/p/31c4306a55ff" target="_blank" rel="external">http://www.jianshu.com/p/31c4306a55ff</a></p>
</li>
</ol>
<p>两者均需要实现<strong>ReactPackage</strong>接口，用来在初始化react组件的时候注册。</p>
<h3 id="js和原生数据类型转换工具类："><a href="#js和原生数据类型转换工具类：" class="headerlink" title="js和原生数据类型转换工具类："></a>js和原生数据类型转换工具类：</h3><ol>
<li><blockquote>
<p>com.facebook.react.bridge.Arguments</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Arguments</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * This method should be used when you need to stub out creating NativeArrays in unit tests.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WritableArray <span class="title">createArray</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WritableNativeArray();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * This method should be used when you need to stub out creating NativeMaps in unit tests.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WritableMap <span class="title">createMap</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WritableNativeMap();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WritableNativeArray <span class="title">fromJavaArgs</span><span class="params">(Object[] args)</span> </span>&#123;</div><div class="line">    WritableNativeArray arguments = <span class="keyword">new</span> WritableNativeArray();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</div><div class="line">      Object argument = args[i];</div><div class="line">      <span class="keyword">if</span> (argument == <span class="keyword">null</span>) &#123;</div><div class="line">        arguments.pushNull();</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Class argumentClass = argument.getClass();</div><div class="line">      <span class="keyword">if</span> (argumentClass == Boolean.class) &#123;</div><div class="line">        arguments.pushBoolean(((Boolean) argument).booleanValue());</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argumentClass == Integer.class) &#123;</div><div class="line">        arguments.pushDouble(((Integer) argument).doubleValue());</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argumentClass == Double.class) &#123;</div><div class="line">        arguments.pushDouble(((Double) argument).doubleValue());</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argumentClass == Float.class) &#123;</div><div class="line">        arguments.pushDouble(((Float) argument).doubleValue());</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argumentClass == String.class) &#123;</div><div class="line">        arguments.pushString(argument.toString());</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argumentClass == WritableNativeMap.class) &#123;</div><div class="line">        arguments.pushMap((WritableNativeMap) argument);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argumentClass == WritableNativeArray.class) &#123;</div><div class="line">        arguments.pushArray((WritableNativeArray) argument);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Cannot convert argument of type "</span> + argumentClass);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> arguments;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Convert an array to a &#123;<span class="doctag">@link</span> WritableArray&#125;.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> array the array to convert. Supported types are: &#123;<span class="doctag">@code</span> String[]&#125;, &#123;<span class="doctag">@code</span> Bundle[]&#125;,</div><div class="line">   * &#123;<span class="doctag">@code</span> int[]&#125;, &#123;<span class="doctag">@code</span> float[]&#125;, &#123;<span class="doctag">@code</span> double[]&#125;, &#123;<span class="doctag">@code</span> boolean[]&#125;.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> the converted &#123;<span class="doctag">@link</span> WritableArray&#125;</div><div class="line">   * <span class="doctag">@throws</span> IllegalArgumentException if the passed object is none of the above types</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WritableArray <span class="title">fromArray</span><span class="params">(Object array)</span> </span>&#123;</div><div class="line">    WritableArray catalystArray = createArray();</div><div class="line">    <span class="keyword">if</span> (array <span class="keyword">instanceof</span> String[]) &#123;</div><div class="line">      <span class="keyword">for</span> (String v: (String[]) array) &#123;</div><div class="line">        catalystArray.pushString(v);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> Bundle[]) &#123;</div><div class="line">      <span class="keyword">for</span> (Bundle v: (Bundle[]) array) &#123;</div><div class="line">        catalystArray.pushMap(fromBundle(v));</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">int</span>[]) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> v: (<span class="keyword">int</span>[]) array) &#123;</div><div class="line">        catalystArray.pushInt(v);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">float</span>[]) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">float</span> v: (<span class="keyword">float</span>[]) array) &#123;</div><div class="line">        catalystArray.pushDouble(v);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">double</span>[]) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">double</span> v: (<span class="keyword">double</span>[]) array) &#123;</div><div class="line">        catalystArray.pushDouble(v);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (array <span class="keyword">instanceof</span> <span class="keyword">boolean</span>[]) &#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">boolean</span> v: (<span class="keyword">boolean</span>[]) array) &#123;</div><div class="line">        catalystArray.pushBoolean(v);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown array type "</span> + array.getClass());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> catalystArray;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Convert a &#123;<span class="doctag">@link</span> Bundle&#125; to a &#123;<span class="doctag">@link</span> WritableMap&#125;. Supported key types in the bundle</div><div class="line">   * are:</div><div class="line">   *</div><div class="line">   * &lt;ul&gt;</div><div class="line">   *   &lt;li&gt;primitive types: int, float, double, boolean&lt;/li&gt;</div><div class="line">   *   &lt;li&gt;arrays supported by &#123;<span class="doctag">@link</span> #fromArray(Object)&#125;&lt;/li&gt;</div><div class="line">   *   &lt;li&gt;&#123;<span class="doctag">@link</span> Bundle&#125; objects that are recursively converted to maps&lt;/li&gt;</div><div class="line">   * &lt;/ul&gt;</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> bundle the &#123;<span class="doctag">@link</span> Bundle&#125; to convert</div><div class="line">   * <span class="doctag">@return</span> the converted &#123;<span class="doctag">@link</span> WritableMap&#125;</div><div class="line">   * <span class="doctag">@throws</span> IllegalArgumentException if there are keys of unsupported types</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> WritableMap <span class="title">fromBundle</span><span class="params">(Bundle bundle)</span> </span>&#123;</div><div class="line">    WritableMap map = createMap();</div><div class="line">    <span class="keyword">for</span> (String key: bundle.keySet()) &#123;</div><div class="line">      Object value = bundle.get(key);</div><div class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">        map.putNull(key);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value.getClass().isArray()) &#123;</div><div class="line">        map.putArray(key, fromArray(value));</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) &#123;</div><div class="line">        map.putString(key, (String) value);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Number) &#123;</div><div class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Integer) &#123;</div><div class="line">          map.putInt(key, (Integer) value);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          map.putDouble(key, ((Number) value).doubleValue());</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Boolean) &#123;</div><div class="line">        map.putBoolean(key, (Boolean) value);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Bundle) &#123;</div><div class="line">        map.putMap(key, fromBundle((Bundle) value));</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Could not convert "</span> + value.getClass());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> map;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Convert a &#123;<span class="doctag">@link</span> WritableMap&#125; to a &#123;<span class="doctag">@link</span> Bundle&#125;.</div><div class="line">   * <span class="doctag">@param</span> readableMap the &#123;<span class="doctag">@link</span> WritableMap&#125; to convert.</div><div class="line">   * <span class="doctag">@return</span> the converted &#123;<span class="doctag">@link</span> Bundle&#125;.</div><div class="line">   */</div><div class="line">  <span class="meta">@Nullable</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bundle <span class="title">toBundle</span><span class="params">(@Nullable ReadableMap readableMap)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (readableMap == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ReadableMapKeySetIterator iterator = readableMap.keySetIterator();</div><div class="line"></div><div class="line">    Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">    <span class="keyword">while</span> (iterator.hasNextKey()) &#123;</div><div class="line">      String key = iterator.nextKey();</div><div class="line">      ReadableType readableType = readableMap.getType(key);</div><div class="line">      <span class="keyword">switch</span> (readableType) &#123;</div><div class="line">        <span class="keyword">case</span> Null:</div><div class="line">          bundle.putString(key, <span class="keyword">null</span>);</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Boolean:</div><div class="line">          bundle.putBoolean(key, readableMap.getBoolean(key));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Number:</div><div class="line">          <span class="comment">// Can be int or double.</span></div><div class="line">          bundle.putDouble(key, readableMap.getDouble(key));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> String:</div><div class="line">          bundle.putString(key, readableMap.getString(key));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Map:</div><div class="line">          bundle.putBundle(key, toBundle(readableMap.getMap(key)));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Array:</div><div class="line">          <span class="comment">// TODO t8873322</span></div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"Arrays aren't supported yet."</span>);</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Could not convert object with key: "</span> + key + <span class="string">"."</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> bundle;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>自定义ConversionUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* package */</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConversionUtil</span> </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line">   * toObject extracts a value from a &#123;<span class="doctag">@link</span> ReadableMap&#125; by its key,</div><div class="line">   * and returns a POJO representing that object.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> readableMap The Map to containing the value to be converted</div><div class="line">   * <span class="doctag">@param</span> key The key for the value to be converted</div><div class="line">   * <span class="doctag">@return</span> The converted POJO</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">toObject</span><span class="params">(@Nullable ReadableMap readableMap, String key)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (readableMap == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Object result;</div><div class="line"></div><div class="line">    ReadableType readableType = readableMap.getType(key);</div><div class="line">    <span class="keyword">switch</span> (readableType) &#123;</div><div class="line">      <span class="keyword">case</span> Null:</div><div class="line">        result = key;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> Boolean:</div><div class="line">        result = readableMap.getBoolean(key);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> Number:</div><div class="line">        <span class="comment">// Can be int or double.</span></div><div class="line">        <span class="keyword">double</span> tmp = readableMap.getDouble(key);</div><div class="line">        <span class="keyword">if</span> (tmp == (<span class="keyword">int</span>) tmp) &#123;</div><div class="line">          result = (<span class="keyword">int</span>) tmp;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          result = tmp;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> String:</div><div class="line">        result = readableMap.getString(key);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> Map:</div><div class="line">        result = toMap(readableMap.getMap(key));</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">case</span> Array:</div><div class="line">        result = toList(readableMap.getArray(key));</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Could not convert object with key: "</span> + key + <span class="string">"."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * toMap converts a &#123;<span class="doctag">@link</span> ReadableMap&#125; into a HashMap.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> readableMap The ReadableMap to be conveted.</div><div class="line">   * <span class="doctag">@return</span> A HashMap containing the data that was in the ReadableMap.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">toMap</span><span class="params">(@Nullable ReadableMap readableMap)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (readableMap == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ReadableMapKeySetIterator iterator = readableMap.keySetIterator();</div><div class="line">    <span class="keyword">if</span> (!iterator.hasNextKey()) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">    <span class="keyword">while</span> (iterator.hasNextKey()) &#123;</div><div class="line">      String key = iterator.nextKey();</div><div class="line">      result.put(key, toObject(readableMap, key));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * toList converts a &#123;<span class="doctag">@link</span> ReadableArray&#125; into an ArrayList.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> readableArray The ReadableArray to be conveted.</div><div class="line">   * <span class="doctag">@return</span> An ArrayList containing the data that was in the ReadableArray.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Object&gt; <span class="title">toList</span><span class="params">(@Nullable ReadableArray readableArray)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (readableArray == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    List&lt;Object&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(readableArray.size());</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; readableArray.size(); index++) &#123;</div><div class="line">      ReadableType readableType = readableArray.getType(index);</div><div class="line">      <span class="keyword">switch</span> (readableType) &#123;</div><div class="line">        <span class="keyword">case</span> Null:</div><div class="line">          result.add(String.valueOf(index));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Boolean:</div><div class="line">          result.add(readableArray.getBoolean(index));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Number:</div><div class="line">          <span class="comment">// Can be int or double.</span></div><div class="line">          <span class="keyword">double</span> tmp = readableArray.getDouble(index);</div><div class="line">          <span class="keyword">if</span> (tmp == (<span class="keyword">int</span>) tmp) &#123;</div><div class="line">            result.add((<span class="keyword">int</span>) tmp);</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            result.add(tmp);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> String:</div><div class="line">          result.add(readableArray.getString(index));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Map:</div><div class="line">          result.add(toMap(readableArray.getMap(index)));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> Array:</div><div class="line">          result = toList(readableArray.getArray(index));</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Could not convert object with index: "</span> + index + <span class="string">"."</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="4-如何发布react-native开发的相关js代码"><a href="#4-如何发布react-native开发的相关js代码" class="headerlink" title="4. 如何发布react-native开发的相关js代码"></a>4. 如何发布react-native开发的相关js代码</h2><p>使用codepush：<a href="https://www.codeproject.com/" target="_blank" rel="external">https://www.codeproject.com/</a></p>
<p>官方文档：<a href="https://microsoft.github.io/code-push/docs/getting-started.html" target="_blank" rel="external">https://microsoft.github.io/code-push/docs/getting-started.html</a></p>
<p>参考文章：<a href="http://www.jianshu.com/p/9e3b4a133bcc" target="_blank" rel="external">http://www.jianshu.com/p/9e3b4a133bcc</a></p>
<ol>
<li><p>安装CodePush CLI：</p>
<blockquote>
<p>npm install -g code-push-cli</p>
</blockquote>
</li>
<li><p>注册CodePush账号：</p>
<blockquote>
<p>code-push register</p>
</blockquote>
</li>
<li><p>登录CodePush账号（注册完成会自动登录，无需此步骤）：</p>
<blockquote>
<p>code-push login</p>
</blockquote>
</li>
<li><p>创建app关联账户：</p>
<blockquote>
<p>code-push app add <appname></appname></p>
</blockquote>
</li>
<li><p>项目集成codepush SDK（见官方文档）</p>
<p>两种方式：</p>
<ol>
<li><a href="https://microsoft.github.io/code-push/docs/react-native.html#plugin-installation-android---rnpm" target="_blank" rel="external"><strong>RNPM</strong></a></li>
<li>手动集成</li>
</ol>
<p>建议使用手动集成，rnpm的作用是自动添加相关的内容至项目中，但是如果项目名称等和模板不一样，会添加失败，到头来还是要手动修改。</p>
<p>注意事项：项目版本号必须为三位，例如 1.0.0，其他格式会出错。</p>
</li>
<li><p>发布app bundle：</p>
<blockquote>
<p>code-push release-react <appname> <platform></platform></appname></p>
</blockquote>
</li>
</ol>
<h2 id="5-jenkins自动打包的坑"><a href="#5-jenkins自动打包的坑" class="headerlink" title="5. jenkins自动打包的坑"></a>5. jenkins自动打包的坑</h2><p>release打包取消勾选该选项：<img src="https://ww4.sinaimg.cn/large/006tNbRwgw1fb0v46hiffj31f00ymq4n.jpg" alt=""></p>
<p>否则会中断打包进程，报类似以下错误：</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&gt; 19:08:12 :app:bundleZmlearnReleaseJsAndAssets</div><div class="line">&gt; 19:08:12 FAILURE: Build failed with an exception.</div><div class="line">&gt; 19:08:12 </div><div class="line">&gt; 19:08:12 * What went wrong:</div><div class="line">&gt; 19:08:12 Failed to capture snapshot of input files for task &apos;bundleZmlearnReleaseJsAndAssets&apos; during up-to-date check.</div><div class="line">&gt; 19:08:12 &gt; Failed to create MD5 hash for file E:\jenkins\workspace\zmlearn_android_am_release\caches\2.14.1\classAnalysis\cache.properties.lock.</div><div class="line">&gt; 19:08:12 </div><div class="line">&gt; 19:08:12 * Try:</div><div class="line">&gt; 19:08:12 Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.</div><div class="line">&gt; 19:08:12 </div><div class="line">&gt; 19:08:12 </div><div class="line">&gt; 19:08:12 BUILD FAILED</div><div class="line">&gt; 19:08:12 </div><div class="line">&gt; 19:08:12 Total time: 4 mins 39.797 secs</div><div class="line">&gt; 19:08:12 Build step &apos;Invoke Gradle script&apos; changed build result to FAILURE</div><div class="line">&gt; 19:08:12 Build step &apos;Invoke Gradle script&apos; marked build as failure</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>原因可参见：<a href="https://discuss.gradle.org/t/build-failure-with-failed-to-capture-snapshot-of-input-files-for-task-war-during-up-to-date-check/9132" target="_blank" rel="external">https://discuss.gradle.org/t/build-failure-with-failed-to-capture-snapshot-of-input-files-for-task-war-during-up-to-date-check/9132</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://chang-chaunce.github.io/posts/android/2017/01/07/react-native开发小结/" data-id="cixu7qajd0000h4255wc96bkz" class="article-share-link">分享到</a><div class="tags"><a href="/tags/react-native/">react-native</a><a href="/tags/android/">android</a></div><div class="post-nav"><a href="/posts/uncategorized/2017/01/10/智能镜子/" class="pre">智能镜子</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://chang-chaunce.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">安卓</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/react-native/" style="font-size: 15px;">react-native</a> <a href="/tags/android/" style="font-size: 15px;">android</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/posts/uncategorized/2017/01/10/智能镜子/">智能镜子</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/android/2017/01/07/react-native开发小结/">android react-native 开发小结（基于react-native 0.39）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.haomwei.com/technology/maupassant-hexo.html" title="blog主题用法" target="_blank">blog主题用法</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Chaunce's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>